name: Sync Forks

on:
  # Run the workflow every Saturday at 7:00 AM
  schedule:
    - cron: "0 7 * * 1"
  # Manually trigger the workflow
  workflow_dispatch:

jobs:
  sync_fork:
    runs-on: ubuntu-latest
    steps:
      - name: Sync forks
        env:
            GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # empty array to store failed forks
          FAILED_FORKS=()
          # get all forks of the owner
          FORKS=$(gh repo list ${{ github.actor }} --fork --limit 50 --json name --jq '.[].name' | tr '\n' ' ')
          if [ -z "$FORKS" ]; then
            echo "No forks found for ${{ github.actor }}"
            exit 0
          fi
          # loop through each fork to sync
          for fork in $FORKS; do
            echo "Syncing fork: $fork"
            DEFAULT_BRANCH=$(gh repo view "$fork" --json defaultBranchRef --jq '.defaultBranchRef.name')
            SYNC_OUTPUT=$(gh repo sync "${{ github.actor }}/$fork" -b "$DEFAULT_BRANCH" 2>&1)

            if echo "$SYNC_OUTPUT" | grep -q "already up to date"; then
              echo "$fork is already up to date."
            elif echo "$SYNC_OUTPUT" | grep -q "Successfully synced"; then
              echo "Successfully synced $fork."
            else
              echo "Failed to sync $fork."
              FAILED_FORKS+=("$fork")
            fi
          done
          # tell the user which forks failed to sync
          if [ ${#FAILED_FORKS[@]} -gt 0 ]; then
            echo "Failed to sync ${#FAILED_FORKS[@]}:"
            printf '%s\n' "${FAILED_FORKS[@]}"
          fi
